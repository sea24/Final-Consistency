> **[中文说明](README.zh-CN.md)**

## gateway

网关程序

## order

订单系统

## integrating

积分系统

## message

消息系统


- 实现 
业务处理服务在业务事务提交前，向实时消息服务请求发送消息，实时消息服务只记录消息数据，而不真正发送。业务处理服务在业务事务提交后，向实时消息服务确认发送。只有在得到确认发送指令后，实时消息服务才真正发送 

- 消息 
    业务处理服务在业务事务回滚后，向实时消息服务取消发送。消息状态确认系统定期 
找到未确认发送或回滚发送的消息，向业务处理服务询问消息状态，业务处理服务根 
据消息ID或消息内容确定该消息是否有效 


- 约束 
被动方的处理结果不影响主动方的处理结果,被动方的消息处理操作是幂等操作 
-成本 
     可靠消息系统建设成本 
     一次消息发送需要两次请求，业务处理服务需实现消息状态回查接口 
- 优点、适用范围 
消息数据独立存储、独立伸缩，降低业务系统与消息系统间的耦合 

- 需要实现的服务 
  可查询操作、幂等操作 
  方案特点 
兼容所有实现AMQP标准的MQ中间件（
确保业务数据可靠的前提下，实现业务数据的最终一致（理想状态下基本是准实时一致） 
适用
 1、对应支付系统会计异步记账业务 
 2、普通的积分账户增加积分的服务

## 思路

1. 主动方应用先把消息发给消息中间件，消息状态标记为“待确认”； 
2. 消息中间件收到消息后，把消息持久化到消息存储中，但并不向被动方应用投递消息； 
3. 消息中间件返回消息持久化结果（成功/失败），主动方应用根据返 
回结果进行判断如何进行业务操作处理： 
a) 失败：放弃业务操作处理，结束（必要时向上层返回失败结果）； 
b) 成功：执行业务操作处理； 
4. 业务操作完成后，把业务操作结果（成功/失败）发送给消息中间件； 
5. 消息中间件收到业务操作结果后，根据业务结果进行处理； 
a) 失败：删除消息存储中的消息，结束； 
b) 成功：更新消息存储中的消息状态为“待发送（可发送）”，紧接 着执行消息投递； 
6. 被动方应用监听并接收“待发送”状态的消息，执行业务处理； 
7. 业务处理完成后，向消息中间件发送ACK，确认消息已经收到（消息 )
中间件将从队列中删除该消息）


## 消息系统组成

1.消息服务子系统：是最重要的一个子系统，它接收并存储预发送的消息，并提供进一步的确认功能。一般需要实现以下接口服务。
存储预发送消息（主动方应用系统）
确认并发送消息（主动方应用系统）
查询状态确认超时的消息（消息状态确认子系统）
确认消息已被成功消费（被动方应用系统）
查询消费确认超时的消息（消息恢复子系统）

2、消息管理子系统：提供一个可视化的管理界面，对可靠消息服务系统中的数据，进行查询和管理。比如可查看已死亡的消息，可通过界面手工重发等。

3、消息状态确认子系统：提供对异常情况的处理。当消息服务子系统收到并保存预发送消息，但因异常情况，没有收到确认发送消息时，这种消息不可能一直留存在数据库中。这种情况的数据，就需要消息状态确认子系统定期捞取这些待确认超时的数据，去调用主动方应用系统中的业务查询接口进行核对确认。根据核对结果决定是发送消息还是删除数据。

4、消息恢复子系统：如果消息数据已经接收到业务确认，这种经过业务确认的消息，就一定要发送到MQ，并被消费方成功消费，绝不能丢。消息恢复子系统定期捞取那些状态是“发送中”，而没有被消费确认的超时消息，进行重新发送。

5、实时消息服务子系统（MQ）：消费方监听程序，接收MQ消息，成功处理后调用消息服务子系统的接口，确认消息已被成功消费，可以删除。


